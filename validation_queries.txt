Active Devices (Breakdown by BU, Account Type)

WITH dsdefinedacct as
     (select platform_customer_id,
             account_type,
             case
             	 when is_test_workspace = true then 'Test Workspace'
             	 when is_test_workspace = false then 'non Test Workspace'
               when is_test_workspace is null then 'Test Workspace'
             end as if_test_workspace
      from "ccs-aquila-tahoe-customersdimension" c 
      WHERE partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '1' DAY, 'yyyy-MM-dd') ),

customers_auth AS
     (SELECT customer_id AS platform_customer_id,
             CASE
                 WHEN organization_id IS NULL THEN 'v1'
                 ELSE 'v2'
             END AS workspace_auth_version
      FROM "ccs-aquila-louise-accountmanagement-customers"
      WHERE platform_customer_id = 'PLATFORM_ACCOUNT' ),
        
                
active_sub as
     (select subscription_key, platform_customer_id
      from "ccs-aquila-tahoe-subscriptiondimension"
      where partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '1' DAY, 'yyyy-MM-dd')
      	and state_type = 'started'
        and subscription_type != 'OPSRAMP'
        and quantity < 10000000 ),

device_sub_dim as
	(
		select subscription_key, serial_number, application_id as app_id
	    from "ccs-aquila-tahoe-devicesubscriptiondimension"
	    where partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '1' DAY, 'yyyy-MM-dd')
	),

 sm_device as
	 (
	 	select serial_number, device_type
	 	from "ccs-aquila-louise-subscriptionmanagement-smdevice"
	 ),


active_dev as
     (select ca.workspace_auth_version,
     	     dda.if_test_workspace,
             dsd.serial_number,
             dda.account_type,
             case
                 when sd.device_type in ('STORAGE',
                                        'DHCI_STORAGE') then 'Storage'
                 when sd.device_type in ('COMPUTE') then 'Compute'
                 when sd.device_type in ('ALS',
                                        'AP',
                                        'CONTROLLER',
                                        'GATEWAY',
                                        'IAP',
                                        'SWITCH',
                                        'SD_WAN_GW',
                                        'BRIDGE') then 'Aruba'
                 when sd.device_type in ('SENSOR') then 'UXI'
                 else 'Others'
             end as BU_device_type,
             dsd.app_id,
             case
                 when dsd.app_id='683da368-66cb-4ee7-90a9-ec1964768092' then 'Aruba'
                 when dsd.app_id='b394fa01-8858-4d73-8818-eadaf12eaf37' then 'Compute'
                 when dsd.app_id='980eea3c-b063-451e-8a45-ebcaa54fd561' then 'Storage'
                 when dsd.app_id='f4cc7322-f1c0-4546-a06c-74e0c3894769' then 'Opsramp'
                 when dsd.app_id='7cc837db-2045-4d58-a16f-b167bb9fd0d2' then 'UXI'
                 when dsd.app_id is null then 'missing'
                 else 'Others'
             end as application_name
      from active_sub as1
      inner join device_sub_dim dsd on dsd.subscription_key=as1.subscription_key
      inner join sm_device sd on sd.serial_number = dsd.serial_number
      left join dsdefinedacct dda on as1.platform_customer_id=dda.platform_customer_id
      left join customers_auth ca on ca.platform_customer_id = dda.platform_customer_id)


select 
	        BU_device_type,
	        app_id,
	        count(distinct serial_number) as cnt_sn
   from active_dev
   where BU_device_type=application_name and if_test_workspace = 'non Test Workspace'
   group by 1,
            2
   order by 1,
            2





Total number of active devices - by BU/WorkpsaceAuthType

WITH dsdefinedacct as
     (select platform_customer_id,
             account_type,
             case
             	 when is_test_workspace = true then 'Test Workspace'
             	 when is_test_workspace = false then 'non Test Workspace'
               when is_test_workspace is null then 'Test Workspace'
             end as if_test_workspace
      from "ccs-aquila-tahoe-customersdimension" c 
      WHERE partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '1' DAY, 'yyyy-MM-dd') ),

customers_auth AS
     (SELECT customer_id AS platform_customer_id,
             CASE
                 WHEN organization_id IS NULL THEN 'v1'
                 ELSE 'v2'
             END AS workspace_auth_version
      FROM "ccs-aquila-louise-accountmanagement-customers"
      WHERE platform_customer_id = 'PLATFORM_ACCOUNT' ),
        
                
active_sub as
     (select subscription_key, platform_customer_id
      from "ccs-aquila-tahoe-subscriptiondimension"
      where partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '1' DAY, 'yyyy-MM-dd')
      	and state_type = 'started'
        and subscription_type != 'OPSRAMP'
        and quantity < 10000000 ),

device_sub_dim as
	(
		select subscription_key, serial_number, application_id as app_id
	    from "ccs-aquila-tahoe-devicesubscriptiondimension"
	    where partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '1' DAY, 'yyyy-MM-dd')
	),

 sm_device as
	 (
	 	select serial_number, device_type
	 	from "ccs-aquila-louise-subscriptionmanagement-smdevice"
	 ),


active_dev as
     (select ca.workspace_auth_version,
     	     dda.if_test_workspace,
             dsd.serial_number,
             dda.account_type,
             case
                 when sd.device_type in ('STORAGE',
                                        'DHCI_STORAGE') then 'Storage'
                 when sd.device_type in ('COMPUTE') then 'Compute'
                 when sd.device_type in ('ALS',
                                        'AP',
                                        'CONTROLLER',
                                        'GATEWAY',
                                        'IAP',
                                        'SWITCH',
                                        'SD_WAN_GW',
                                        'BRIDGE') then 'Aruba'
                 when sd.device_type in ('SENSOR') then 'UXI'
                 else 'Others'
             end as BU_device_type,
             dsd.app_id,
             case
                 when dsd.app_id='683da368-66cb-4ee7-90a9-ec1964768092' then 'Aruba'
                 when dsd.app_id='b394fa01-8858-4d73-8818-eadaf12eaf37' then 'Compute'
                 when dsd.app_id='980eea3c-b063-451e-8a45-ebcaa54fd561' then 'Storage'
                 when dsd.app_id='f4cc7322-f1c0-4546-a06c-74e0c3894769' then 'Opsramp'
                 when dsd.app_id='7cc837db-2045-4d58-a16f-b167bb9fd0d2' then 'UXI'
                 when dsd.app_id is null then 'missing'
                 else 'Others'
             end as application_name
      from active_sub as1
      inner join device_sub_dim dsd on dsd.subscription_key=as1.subscription_key
      inner join sm_device sd on sd.serial_number = dsd.serial_number
      left join dsdefinedacct dda on as1.platform_customer_id=dda.platform_customer_id
      left join customers_auth ca on ca.platform_customer_id = dda.platform_customer_id)


select 
workspace_auth_version,
	        BU_device_type,
	        app_id,
	        count(distinct serial_number) as cnt_sn
   from active_dev
   where BU_device_type=application_name and if_test_workspace = 'non Test Workspace'
   group by 1,
            2,
            3
            
   order by 1,
            2,
            3



Total Number of active devices - by BU/WorkspaceAuthType/AccountType

WITH dsdefinedacct as
     (select platform_customer_id,
             account_type,
             case
             	 when is_test_workspace = true then 'Test Workspace'
             	 when is_test_workspace = false then 'non Test Workspace'
               when is_test_workspace is null then 'Test Workspace'
             end as if_test_workspace
      from "ccs-aquila-tahoe-customersdimension" c 
      WHERE partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '1' DAY, 'yyyy-MM-dd') ),

customers_auth AS
     (SELECT customer_id AS platform_customer_id,
             CASE
                 WHEN organization_id IS NULL THEN 'v1'
                 ELSE 'v2'
             END AS workspace_auth_version
      FROM "ccs-aquila-louise-accountmanagement-customers"
      WHERE platform_customer_id = 'PLATFORM_ACCOUNT' ),
        
                
active_sub as
     (select subscription_key, platform_customer_id
      from "ccs-aquila-tahoe-subscriptiondimension"
      where partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '1' DAY, 'yyyy-MM-dd')
      	and state_type = 'started'
        and subscription_type != 'OPSRAMP'
        and quantity < 10000000 ),

device_sub_dim as
	(
		select subscription_key, serial_number, application_id as app_id
	    from "ccs-aquila-tahoe-devicesubscriptiondimension"
	    where partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '1' DAY, 'yyyy-MM-dd')
	),

 sm_device as
	 (
	 	select serial_number, device_type
	 	from "ccs-aquila-louise-subscriptionmanagement-smdevice"
	 ),


active_dev as
     (select ca.workspace_auth_version,
     	     dda.if_test_workspace,
             dsd.serial_number,
             dda.account_type,
             case
                 when sd.device_type in ('STORAGE',
                                        'DHCI_STORAGE') then 'Storage'
                 when sd.device_type in ('COMPUTE') then 'Compute'
                 when sd.device_type in ('ALS',
                                        'AP',
                                        'CONTROLLER',
                                        'GATEWAY',
                                        'IAP',
                                        'SWITCH',
                                        'SD_WAN_GW',
                                        'BRIDGE') then 'Aruba'
                 when sd.device_type in ('SENSOR') then 'UXI'
                 else 'Others'
             end as BU_device_type,
             dsd.app_id,
             case
                 when dsd.app_id='683da368-66cb-4ee7-90a9-ec1964768092' then 'Aruba'
                 when dsd.app_id='b394fa01-8858-4d73-8818-eadaf12eaf37' then 'Compute'
                 when dsd.app_id='980eea3c-b063-451e-8a45-ebcaa54fd561' then 'Storage'
                 when dsd.app_id='f4cc7322-f1c0-4546-a06c-74e0c3894769' then 'Opsramp'
                 when dsd.app_id='7cc837db-2045-4d58-a16f-b167bb9fd0d2' then 'UXI'
                 when dsd.app_id is null then 'missing'
                 else 'Others'
             end as application_name
      from active_sub as1
      inner join device_sub_dim dsd on dsd.subscription_key=as1.subscription_key
      inner join sm_device sd on sd.serial_number = dsd.serial_number
      left join dsdefinedacct dda on as1.platform_customer_id=dda.platform_customer_id
      left join customers_auth ca on ca.platform_customer_id = dda.platform_customer_id)


select 
workspace_auth_version,
	        BU_device_type,
	        app_id,
	        account_type ,
	        count(distinct serial_number) as cnt_sn
   from active_dev
   where BU_device_type=application_name and if_test_workspace = 'non Test Workspace'
   group by 1,
            2,
            3,4
            
   order by 1,
            2,
            3,4



Number of Storage Devices by storage_type

WITH filtered_users AS (
    SELECT 
        platform_customer_id, 
        customer_company_region,
        CASE 
            WHEN COUNT(*) = COUNT(
                CASE 
                    WHEN LOWER(SPLIT_PART(username, '@', 2)) IN (
                        'glcptest.com',
                        'esc-std.glcpsoltest.net',
                        'hpe.com',
                        'hpe.hr',
                        'hpecds.com',
                        'hpedemos.com',
                        'hpedemos.net',
                        'hpedev.io',
                        'hpelabsonline.com',
                        'hpevlabs.net',
                        'groups.ext.hpe.com',
                        'merlin.test.glc.hpe.com',
                        'recovery.auth.greenlake.hpe.com',
                        'testhpe.com',
                        'aruba-expert.com',
                        'aruba-workbench.com',
                        'aruba.flane.de',
                        'arubademo.net',
                        'arubanetworks.com',
                        'arubatraininglabs.net',
                        'arubaworkshops.net',
                        'gmail.com',
                        'yahoo.co.in',
                        'yahoo.co.uk',
                        'yahoo.com',
                        'yahoo.com.mx',
                        'outlook.com',
                        'outlook.com.br',
                        'outlook.dk',
                        'outlook.es',
                        'outlook.fr',
                        'hotmail.co.uk',
                        'hotmail.com',
                        'hotmail.de',
                        'hotmail.fr',
                        '126.com'
                    ) THEN 1 
                END
            )
            THEN 'Test Workspace'
            ELSE 'non Test Workspace'
        END AS test_type
    FROM "ccs-aquila-tahoe-usersdimension"
    WHERE partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '2' DAY, 'yyyy-MM-dd')
    GROUP BY platform_customer_id, customer_company_region
),

filtered_devices_for_storage AS (
    SELECT 
        serial_number, 
        part_number, 
        device_model
    FROM "ccs-aquila-louise-subscriptionmanagement-smdevice"
    WHERE device_type IN ('STORAGE', 'DHCI_STORAGE')
),

device_sub_dim AS (
    SELECT 
        serial_number, 
        part_number, 
        platform_customer_id, 
        application_instance_id
    FROM "ccs-aquila-tahoe-devicesubscriptiondimension"
    WHERE partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '1' DAY, 'yyyy-MM-dd')
),

customers_auth AS (
    SELECT 
        customer_id AS platform_customer_id,
        CASE
            WHEN organization_id IS NULL THEN 'v1'
            ELSE 'v2'
        END AS workspace_auth_version 
    FROM "ccs-aquila-louise-accountmanagement-customers"
    WHERE platform_customer_id = 'PLATFORM_ACCOUNT' 
),

app_instance AS (
    SELECT 
        instance_id, 
        ccs_region
    FROM "ccs-aquila-louise-appcatalog-appinstances"
),

final_df AS (
    SELECT 
        test_type, 
        ds.platform_customer_id, 
        ccs_region,
        CASE 
            WHEN UPPER(device_model) LIKE 'HPE NS DHCI%ALLETRA 5% CTO ARRAY' THEN 'PCBE A5K'
            WHEN UPPER(device_model) LIKE 'HPE NS DHCI%ALLETRA 6%' THEN 'PCBE A6K'
            WHEN UPPER(device_model) LIKE '%DHCI%BASE ARRAY' THEN 'PCBE Nimble'
            WHEN UPPER(device_model) = 'HPE GL PRV CLD W/AL STG MP BASE CONFIG' THEN 'PCBE MP'
            WHEN UPPER(device_model) LIKE 'HPE PRIMERA%CONTROLLER%'
              OR UPPER(device_model) LIKE 'HPE 3PAR 600%S NODE' THEN 'Block Primera'
            WHEN UPPER(device_model) LIKE '%ALLETRA 5%' THEN 'Block A5K'
            WHEN UPPER(device_model) LIKE 'HPE ALLETRA 6%'
              OR UPPER(device_model) LIKE 'HPE NS 6% CTO BASE ARRAY' THEN 'Block A6K'
            WHEN UPPER(device_model) LIKE 'HPE NS%DC CTO BASE ARRAY' THEN 'Block Nimble'
            WHEN UPPER(device_model) LIKE '%ALLETRA 9%' THEN 'Block A9K'
            WHEN UPPER(device_model) IN (
                'HPE GL BLOCK STG MP BASE CLSTR CONFIG',
                'HPE GREENLAKE FOR BLOCK STORAGE MP BASE CONFIG'
            ) THEN 'Block AMP'
            WHEN UPPER(device_model) IN (
                'HPE GREENLAKE FILE STG MP BASE CONFIG',
                'HPE GREENLAKE FILE STG MP HD BASE CONFIG'
            ) THEN 'File AMP'
            WHEN UPPER(device_model) = 'HPE GREENLAKE BLOCK STORAGE FOR AWS VIRTUAL CONFIG' THEN 'Block AWS'
            ELSE 'others'
        END AS storage_type, 
        device_model, 
        workspace_auth_version
    FROM filtered_devices_for_storage d
    INNER JOIN device_sub_dim ds
        ON d.serial_number = ds.serial_number 
       AND d.part_number = ds.part_number
    LEFT JOIN filtered_users u
        ON ds.platform_customer_id = u.platform_customer_id
    LEFT JOIN customers_auth c
        ON ds.platform_customer_id = c.platform_customer_id
    LEFT JOIN app_instance a
        ON ds.application_instance_id = a.instance_id
),

finalised_df AS (
    SELECT 
        *,     
        CASE
            WHEN storage_type IN (
                'Block A5K', 'Block A6K', 'Block A9K', 
                'Block AMP', 'Block Nimble', 'Block Primera', 'Block AWS'
            ) THEN 'Block'
            WHEN storage_type = 'File AMP' THEN 'File'
            WHEN storage_type IN ('PCBE A5K', 'PCBE A6K', 'PCBE Nimble', 'PCBE MP') THEN 'PCBE'
            ELSE 'others'
        END AS storage_type_2
    FROM final_df
)

SELECT 
    storage_type, 
    -- storage_type_2, 
    -- ccs_region, 
    COUNT(*) AS device_cnt
FROM finalised_df where test_type = 'non Test Workspace'
GROUP BY 
 
    storage_type
    -- , 
    -- storage_type_2, 
    -- ccs_region



Number of workspaces having storage devices

WITH filtered_users AS (
    SELECT 
        platform_customer_id, 
        customer_company_region,
        CASE 
            WHEN COUNT(*) = COUNT(
                CASE 
                    WHEN LOWER(SPLIT_PART(username, '@', 2)) IN (
                        'glcptest.com',
                        'esc-std.glcpsoltest.net',
                        'hpe.com',
                        'hpe.hr',
                        'hpecds.com',
                        'hpedemos.com',
                        'hpedemos.net',
                        'hpedev.io',
                        'hpelabsonline.com',
                        'hpevlabs.net',
                        'groups.ext.hpe.com',
                        'merlin.test.glc.hpe.com',
                        'recovery.auth.greenlake.hpe.com',
                        'testhpe.com',
                        'aruba-expert.com',
                        'aruba-workbench.com',
                        'aruba.flane.de',
                        'arubademo.net',
                        'arubanetworks.com',
                        'arubatraininglabs.net',
                        'arubaworkshops.net',
                        'gmail.com',
                        'yahoo.co.in',
                        'yahoo.co.uk',
                        'yahoo.com',
                        'yahoo.com.mx',
                        'outlook.com',
                        'outlook.com.br',
                        'outlook.dk',
                        'outlook.es',
                        'outlook.fr',
                        'hotmail.co.uk',
                        'hotmail.com',
                        'hotmail.de',
                        'hotmail.fr',
                        '126.com'
                    ) THEN 1 
                END
            )
            THEN 'Test Workspace'
            ELSE 'non Test Workspace'
        END AS test_type
    FROM "ccs-aquila-tahoe-usersdimension"
    WHERE partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '2' DAY, 'yyyy-MM-dd')
    GROUP BY platform_customer_id, customer_company_region
),

filtered_devices_for_storage AS (
    SELECT 
        serial_number, 
        part_number, 
        device_model
    FROM "ccs-aquila-louise-subscriptionmanagement-smdevice"
    WHERE device_type IN ('STORAGE', 'DHCI_STORAGE')
),

device_sub_dim AS (
    SELECT 
        serial_number, 
        part_number, 
        platform_customer_id, 
        application_instance_id
    FROM "ccs-aquila-tahoe-devicesubscriptiondimension"
    WHERE partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '1' DAY, 'yyyy-MM-dd')
),

customers_auth AS (
    SELECT 
        customer_id AS platform_customer_id,
        CASE
            WHEN organization_id IS NULL THEN 'v1'
            ELSE 'v2'
        END AS workspace_auth_version 
    FROM "ccs-aquila-louise-accountmanagement-customers"
    WHERE platform_customer_id = 'PLATFORM_ACCOUNT' 
),

app_instance AS (
    SELECT 
        instance_id, 
        ccs_region
    FROM "ccs-aquila-louise-appcatalog-appinstances"
),

final_df AS (
    SELECT 
        test_type, 
        ds.platform_customer_id, 
        ccs_region,
        CASE 
            WHEN UPPER(device_model) LIKE 'HPE NS DHCI%ALLETRA 5% CTO ARRAY' THEN 'PCBE A5K'
            WHEN UPPER(device_model) LIKE 'HPE NS DHCI%ALLETRA 6%' THEN 'PCBE A6K'
            WHEN UPPER(device_model) LIKE '%DHCI%BASE ARRAY' THEN 'PCBE Nimble'
            WHEN UPPER(device_model) = 'HPE GL PRV CLD W/AL STG MP BASE CONFIG' THEN 'PCBE MP'
            WHEN UPPER(device_model) LIKE 'HPE PRIMERA%CONTROLLER%'
              OR UPPER(device_model) LIKE 'HPE 3PAR 600%S NODE' THEN 'Block Primera'
            WHEN UPPER(device_model) LIKE '%ALLETRA 5%' THEN 'Block A5K'
            WHEN UPPER(device_model) LIKE 'HPE ALLETRA 6%'
              OR UPPER(device_model) LIKE 'HPE NS 6% CTO BASE ARRAY' THEN 'Block A6K'
            WHEN UPPER(device_model) LIKE 'HPE NS%DC CTO BASE ARRAY' THEN 'Block Nimble'
            WHEN UPPER(device_model) LIKE '%ALLETRA 9%' THEN 'Block A9K'
            WHEN UPPER(device_model) IN (
                'HPE GL BLOCK STG MP BASE CLSTR CONFIG',
                'HPE GREENLAKE FOR BLOCK STORAGE MP BASE CONFIG'
            ) THEN 'Block AMP'
            WHEN UPPER(device_model) IN (
                'HPE GREENLAKE FILE STG MP BASE CONFIG',
                'HPE GREENLAKE FILE STG MP HD BASE CONFIG'
            ) THEN 'File AMP'
            WHEN UPPER(device_model) = 'HPE GREENLAKE BLOCK STORAGE FOR AWS VIRTUAL CONFIG' THEN 'Block AWS'
            ELSE 'others'
        END AS storage_type, 
        device_model, 
        workspace_auth_version
    FROM filtered_devices_for_storage d
    INNER JOIN device_sub_dim ds
        ON d.serial_number = ds.serial_number 
       AND d.part_number = ds.part_number
    LEFT JOIN filtered_users u
        ON ds.platform_customer_id = u.platform_customer_id
    LEFT JOIN customers_auth c
        ON ds.platform_customer_id = c.platform_customer_id
    LEFT JOIN app_instance a
        ON ds.application_instance_id = a.instance_id
),

finalised_df AS (
    SELECT 
        *,     
        CASE
            WHEN storage_type IN (
                'Block A5K', 'Block A6K', 'Block A9K', 
                'Block AMP', 'Block Nimble', 'Block Primera', 'Block AWS'
            ) THEN 'Block'
            WHEN storage_type = 'File AMP' THEN 'File'
            WHEN storage_type IN ('PCBE A5K', 'PCBE A6K', 'PCBE Nimble', 'PCBE MP') THEN 'PCBE'
            ELSE 'others'
        END AS storage_type_2
    FROM final_df
)

SELECT 
    -- storage_type, 
    storage_type_2, 
    -- ccs_region, 
    COUNT(DISTINCT platform_customer_id) AS cnt_pcid
FROM finalised_df where test_type = 'non Test Workspace'
GROUP BY 
 
    storage_type_2
    -- , 
    -- storage_type_2, 
    -- ccs_region

Number of storage Block AMP devices Breakdown by instance_region

WITH filtered_users AS (
    SELECT 
        platform_customer_id, 
        customer_company_region,
        CASE 
            WHEN COUNT(*) = COUNT(
                CASE 
                    WHEN LOWER(SPLIT_PART(username, '@', 2)) IN (
                        'glcptest.com',
                        'esc-std.glcpsoltest.net',
                        'hpe.com',
                        'hpe.hr',
                        'hpecds.com',
                        'hpedemos.com',
                        'hpedemos.net',
                        'hpedev.io',
                        'hpelabsonline.com',
                        'hpevlabs.net',
                        'groups.ext.hpe.com',
                        'merlin.test.glc.hpe.com',
                        'recovery.auth.greenlake.hpe.com',
                        'testhpe.com',
                        'aruba-expert.com',
                        'aruba-workbench.com',
                        'aruba.flane.de',
                        'arubademo.net',
                        'arubanetworks.com',
                        'arubatraininglabs.net',
                        'arubaworkshops.net',
                        'gmail.com',
                        'yahoo.co.in',
                        'yahoo.co.uk',
                        'yahoo.com',
                        'yahoo.com.mx',
                        'outlook.com',
                        'outlook.com.br',
                        'outlook.dk',
                        'outlook.es',
                        'outlook.fr',
                        'hotmail.co.uk',
                        'hotmail.com',
                        'hotmail.de',
                        'hotmail.fr',
                        '126.com'
                    ) THEN 1 
                END
            )
            THEN 'Test Workspace'
            ELSE 'non Test Workspace'
        END AS test_type
    FROM "ccs-aquila-tahoe-usersdimension"
    WHERE partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '2' DAY, 'yyyy-MM-dd')
    GROUP BY platform_customer_id, customer_company_region
),

filtered_devices_for_storage AS (
    SELECT 
        serial_number, 
        part_number, 
        device_model
    FROM "ccs-aquila-louise-subscriptionmanagement-smdevice"
    WHERE device_type IN ('STORAGE', 'DHCI_STORAGE')
),

device_sub_dim AS (
    SELECT 
        serial_number, 
        part_number, 
        platform_customer_id, 
        application_instance_id
    FROM "ccs-aquila-tahoe-devicesubscriptiondimension"
    WHERE partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '1' DAY, 'yyyy-MM-dd')
),

customers_auth AS (
    SELECT 
        customer_id AS platform_customer_id,
        CASE
            WHEN organization_id IS NULL THEN 'v1'
            ELSE 'v2'
        END AS workspace_auth_version 
    FROM "ccs-aquila-louise-accountmanagement-customers"
    WHERE platform_customer_id = 'PLATFORM_ACCOUNT' 
),

app_instance AS (
    SELECT 
        instance_id, 
        ccs_region
    FROM "ccs-aquila-louise-appcatalog-appinstances"
),

final_df AS (
    SELECT 
        test_type, 
        ds.platform_customer_id, 
        ccs_region,
        CASE 
            WHEN UPPER(device_model) LIKE 'HPE NS DHCI%ALLETRA 5% CTO ARRAY' THEN 'PCBE A5K'
            WHEN UPPER(device_model) LIKE 'HPE NS DHCI%ALLETRA 6%' THEN 'PCBE A6K'
            WHEN UPPER(device_model) LIKE '%DHCI%BASE ARRAY' THEN 'PCBE Nimble'
            WHEN UPPER(device_model) = 'HPE GL PRV CLD W/AL STG MP BASE CONFIG' THEN 'PCBE MP'
            WHEN UPPER(device_model) LIKE 'HPE PRIMERA%CONTROLLER%'
              OR UPPER(device_model) LIKE 'HPE 3PAR 600%S NODE' THEN 'Block Primera'
            WHEN UPPER(device_model) LIKE '%ALLETRA 5%' THEN 'Block A5K'
            WHEN UPPER(device_model) LIKE 'HPE ALLETRA 6%'
              OR UPPER(device_model) LIKE 'HPE NS 6% CTO BASE ARRAY' THEN 'Block A6K'
            WHEN UPPER(device_model) LIKE 'HPE NS%DC CTO BASE ARRAY' THEN 'Block Nimble'
            WHEN UPPER(device_model) LIKE '%ALLETRA 9%' THEN 'Block A9K'
            WHEN UPPER(device_model) IN (
                'HPE GL BLOCK STG MP BASE CLSTR CONFIG',
                'HPE GREENLAKE FOR BLOCK STORAGE MP BASE CONFIG'
            ) THEN 'Block AMP'
            WHEN UPPER(device_model) IN (
                'HPE GREENLAKE FILE STG MP BASE CONFIG',
                'HPE GREENLAKE FILE STG MP HD BASE CONFIG'
            ) THEN 'File AMP'
            WHEN UPPER(device_model) = 'HPE GREENLAKE BLOCK STORAGE FOR AWS VIRTUAL CONFIG' THEN 'Block AWS'
            ELSE 'others'
        END AS storage_type, 
        device_model, 
        workspace_auth_version
    FROM filtered_devices_for_storage d
    INNER JOIN device_sub_dim ds
        ON d.serial_number = ds.serial_number 
       AND d.part_number = ds.part_number
    LEFT JOIN filtered_users u
        ON ds.platform_customer_id = u.platform_customer_id
    LEFT JOIN customers_auth c
        ON ds.platform_customer_id = c.platform_customer_id
    LEFT JOIN app_instance a
        ON ds.application_instance_id = a.instance_id
),

finalised_df AS (
    SELECT 
        *,     
        CASE
            WHEN storage_type IN (
                'Block A5K', 'Block A6K', 'Block A9K', 
                'Block AMP', 'Block Nimble', 'Block Primera', 'Block AWS'
            ) THEN 'Block'
            WHEN storage_type = 'File AMP' THEN 'File'
            WHEN storage_type IN ('PCBE A5K', 'PCBE A6K', 'PCBE Nimble', 'PCBE MP') THEN 'PCBE'
            ELSE 'others'
        END AS storage_type_2
    FROM final_df
)

SELECT 
    storage_type, 
    ccs_region, 
    COUNT(DISTINCT platform_customer_id) AS cnt_pcid
FROM finalised_df where test_type = 'non Test Workspace' and storage_type = 'Block AMP'
GROUP BY 
 
    storage_type,
    ccs_region



Number of compute devices by compute type

WITH filtered_users AS (
    SELECT  platform_customer_id,
             account_type,
             case
             	 when is_test_workspace = true then 'Test Workspace'
             	 when is_test_workspace = false then 'non Test Workspace'
               when is_test_workspace is null then 'Test Workspace'
             end as if_test_workspace
      from "ccs-aquila-tahoe-customersdimension" c 
      WHERE partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '1' DAY, 'yyyy-MM-dd') 
),

compute_devices AS (
    SELECT 
        platform_customer_id,
        CASE
            WHEN LOWER(device_model) LIKE '%gen10%' OR LOWER(device_model) LIKE '%gen 10%' THEN 'GEN10'
            WHEN LOWER(device_model) LIKE '%gen11%' OR LOWER(device_model) LIKE '%gen 11%' THEN 'GEN11'
            WHEN device_model IS NULL THEN 'missing'
            ELSE device_model
        END AS device_model_category,
        COUNT(DISTINCT serial_number) AS cnt_dev
    FROM "ccs-aquila-tahoe-devicedimension"
    WHERE application_id = 'b394fa01-8858-4d73-8818-eadaf12eaf37' 
      AND partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '1' DAY, 'yyyy-MM-dd')
      AND is_active = true
    GROUP BY platform_customer_id, 
             CASE
                 WHEN LOWER(device_model) LIKE '%gen10%' OR LOWER(device_model) LIKE '%gen 10%' THEN 'GEN10'
                 WHEN LOWER(device_model) LIKE '%gen11%' OR LOWER(device_model) LIKE '%gen 11%' THEN 'GEN11'
                 WHEN device_model IS NULL THEN 'missing'
                 ELSE device_model
             END
),
customers_auth AS (
    SELECT 
        customer_id AS platform_customer_id,
        CASE
            WHEN organization_id IS NULL THEN 'v1'
            ELSE 'v2'
        END AS workspace_auth_version 
    FROM "ccs-aquila-louise-accountmanagement-customers"
    WHERE platform_customer_id = 'PLATFORM_ACCOUNT' 
),



final_df AS (
    SELECT 
        d.*,
        u.if_test_workspace,
        auth.workspace_auth_version
    FROM compute_devices AS d 
    LEFT JOIN filtered_users AS u
    ON d.platform_customer_id = u.platform_customer_id
    LEFT JOIN customers_auth AS auth
    ON auth.platform_customer_id = d.platform_customer_id
)

SELECT 
    device_model_category,
    if_test_workspace as test_type , sum(cnt_dev)
FROM final_df 
group by device_model_category, if_test_workspace
Having if_test_workspace = 'non Test Workspace'

Number of Active Subscriptions


SELECT "BU_subtype" AS "BU_subtype",
       sum(cnt_key) AS "Number of Subscription Keys",
       SUM(cnt_seats) AS "Number of Subscription Seats"
FROM
  (WITH nontest_user AS
     (select platform_customer_id,
             account_type,
             case
                 when is_test_workspace = true then 'Test Workspace'
                 when is_test_workspace = false then 'non Test Workspace'
                 when is_test_workspace is null then 'Test Workspace'
             end as if_test_workspace
      from "ccs-aquila-tahoe-customersdimension" c
      WHERE partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '1' DAY, 'yyyy-MM-dd') ),
        dsdefinedacct AS
     (SELECT customer_id AS platform_customer_id,
             CASE
                 WHEN c.organization_id IS NULL THEN 'v1'
                 ELSE 'v2'
             END AS workspace_auth_version
      FROM "ccs-aquila-louise-accountmanagement-customers" c
      WHERE c.platform_customer_id = 'PLATFORM_ACCOUNT' ),
        active_subscriptions AS
     (SELECT platform_customer_id,
             evaluation_type,
             state_type AS status,
             subscription_key,
             quantity,
             subscription_tier,
             CASE
                 WHEN subscription_type = 'CENTRAL_STORAGE' THEN 'Storage'
                 WHEN subscription_type = 'CENTRAL_COMPUTE' THEN 'Compute'
                 WHEN subscription_type LIKE 'UXI%' THEN 'UXI'
                 WHEN subscription_type='OPSRAMP' THEN 'Opsramp'
                 ELSE 'Aruba'
             END AS BU_subtype
      FROM "ccs-aquila-tahoe-subscriptiondimension"
      WHERE quantity < 10000000
        AND state_type = 'started'
        AND partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '1' DAY, 'yyyy-MM-dd') ) SELECT ntu.if_test_workspace as test_type,
                                                                                                     dda.workspace_auth_version,
                                                                                                     acs.BU_subtype,
                                                                                                     acs.status,
                                                                                                     acs.evaluation_type,
                                                                                                     acs.subscription_tier,
                                                                                                     COUNT(DISTINCT acs.subscription_key) AS cnt_key,
                                                                                                     SUM(acs.quantity) AS cnt_seats
   FROM active_subscriptions acs
   LEFT JOIN dsdefinedacct dda ON acs.platform_customer_id = dda.platform_customer_id
   LEFT JOIN nontest_user ntu ON acs.platform_customer_id = ntu.platform_customer_id
   GROUP BY 1,
            2,
            3,
            4,
            5,
            6) AS virtual_table
WHERE test_type IN ('non Test Workspace')
  --AND workspace_auth_version IN ('v1') --forv1
  --AND workspace_auth_version IN ('v2') --forv2
  AND ((BU_subtype IN ('UXI',
                       'Aruba',
                       'Compute',
                       'Storage')))
GROUP BY "BU_subtype"
ORDER BY BU_subtype ASC
LIMIT 1000;

Number of Compute Subscriptions Deep Dive

SELECT subscription_tier AS subscription_tier,
       SUM(cnt_key) AS "Number of Subscription Keys",
       SUM(cnt_seats) AS "Number of Subscription Seats"
FROM
  (WITH nontest_user AS
     (select platform_customer_id,
             account_type,
             case
                 when is_test_workspace = true then 'Test Workspace'
                 when is_test_workspace = false then 'non Test Workspace'
                 when is_test_workspace is null then 'Test Workspace'
             end as if_test_workspace
      from "ccs-aquila-tahoe-customersdimension" c
      WHERE partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '1' DAY, 'yyyy-MM-dd') ),
        dsdefinedacct AS
     (SELECT customer_id AS platform_customer_id,
             CASE
                 WHEN c.organization_id IS NULL THEN 'v1'
                 ELSE 'v2'
             END AS workspace_auth_version
      FROM "ccs-aquila-louise-accountmanagement-customers" c
      WHERE c.platform_customer_id = 'PLATFORM_ACCOUNT' ),
        active_subscriptions AS
     (SELECT platform_customer_id,
             evaluation_type,
             state_type AS status,
             subscription_key,
             quantity,
             subscription_tier,
             CASE
                 WHEN subscription_type = 'CENTRAL_STORAGE' THEN 'Storage'
                 WHEN subscription_type = 'CENTRAL_COMPUTE' THEN 'Compute'
                 WHEN subscription_type LIKE 'UXI%' THEN 'UXI'
                 WHEN subscription_type='OPSRAMP' THEN 'Opsramp'
                 ELSE 'Aruba'
             END AS BU_subtype
      FROM "ccs-aquila-tahoe-subscriptiondimension"
      WHERE quantity < 10000000
        AND state_type = 'started'
        AND partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '1' DAY, 'yyyy-MM-dd') ) SELECT ntu.if_test_workspace as test_type,
                                                                                                     dda.workspace_auth_version,
                                                                                                     acs.BU_subtype,
                                                                                                     acs.status,
                                                                                                     acs.evaluation_type,
                                                                                                     acs.subscription_tier,
                                                                                                     COUNT(DISTINCT acs.subscription_key) AS cnt_key,
                                                                                                     SUM(acs.quantity) AS cnt_seats
   FROM active_subscriptions acs
   LEFT JOIN dsdefinedacct dda ON acs.platform_customer_id = dda.platform_customer_id
   LEFT JOIN nontest_user ntu ON acs.platform_customer_id = ntu.platform_customer_id
   GROUP BY 1,
            2,
            3,
            4,
            5,
            6) AS virtual_table
WHERE test_type IN ('non Test Workspace')
  AND ((BU_subtype IN ('Compute')))
GROUP BY subscription_tier
ORDER BY "Number of Subscription Keys" DESC
LIMIT 1000;

Number of Subscriptions Renewed (all renewed until now)

SELECT "BU" AS "BU",
       SUM(cnt_key) AS "Number of Subscription Keys"
FROM
  (WITH nontest_user AS
     (select platform_customer_id,
             account_type,
             case
                 when is_test_workspace = true then 'Test Workspace'
                 when is_test_workspace = false then 'non Test Workspace'
                 when is_test_workspace is null then 'Test Workspace'
             end as test_type
      from "ccs-aquila-tahoe-customersdimension" c
      WHERE partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '1' DAY, 'yyyy-MM-dd') ),
        dsdefinedacct AS
     (SELECT customer_id AS platform_customer_id,
             CASE
                 WHEN c.organization_id IS NULL THEN 'v1'
                 ELSE 'v2'
             END AS workspace_auth_version
      FROM "ccs-aquila-louise-accountmanagement-customers" c
      WHERE c.platform_customer_id = 'PLATFORM_ACCOUNT' ),
        subs AS
     (SELECT platform_customer_id,
             evaluation_type,
             subscription_key,
             subscription_tier,
             subscription_start,
             subscription_end,
             CASE
                 WHEN subscription_type = 'CENTRAL_STORAGE' THEN 'Storage'
                 WHEN subscription_type = 'CENTRAL_COMPUTE' THEN 'Compute'
                 WHEN subscription_type LIKE 'UXI%' THEN 'UXI'
                 when subscription_type='OPSRAMP' THEN 'Opsramp'
                 ELSE 'Aruba'
             END AS BU_subtype
      FROM "ccs-aquila-tahoe-subscriptiondimension"
      WHERE partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '1' DAY, 'yyyy-MM-dd') ),
        all_subs as
     (SELECT s.platform_customer_id,
             workspace_auth_version,
             evaluation_type,
             subscription_key,
             subscription_tier,
             subscription_start,
             subscription_end,
             BU_subtype,
             test_type
      FROM subs s
      LEFT JOIN dsdefinedacct dda on s.platform_customer_id = dda.platform_customer_id
      LEFT JOIN nontest_user ntu on ntu.platform_customer_id = s.platform_customer_id),
        temp_sub_renewal as
     (select a.platform_customer_id,
             a.test_type,
             a.workspace_auth_version,
             a.subscription_key as key1,
             a.BU_subtype as bu1,
             b.subscription_key as key2,
             b.BU_subtype as bu2,
             date_diff('month', a.subscription_end, b.subscription_start) as diff
      from all_subs a
      inner join all_subs b on a.platform_customer_id=b.platform_customer_id
      and a.subscription_tier=b.subscription_tier
      and a.subscription_start<= b.subscription_start
      and a.subscription_key != b.subscription_key
      where a.evaluation_type='NONE'
        and b.evaluation_type='NONE' ) select test_type,
                                              workspace_auth_version,
                                              bu1 as BU,
                                              bu2,
                                              count(distinct key2) as cnt_key
   from temp_sub_renewal
   where (diff between -1 and 1)
   group by 1,
            2,
            3,
            4) AS virtual_table
WHERE test_type IN ('non Test Workspace')
  AND ((BU IN ('UXI',
               'Aruba',
               'Compute',
               'Storage')))
GROUP BY "BU"
ORDER BY BU ASC
LIMIT 1000;

Number of EVAL Subscriptions Expired per month

SELECT sub_end_ym AS sub_end_ym,
       SUM(cnt_aruba) AS "Number of Aruba Subscription Keys",
       SUM(cnt_compute) AS "Number of Compute Subscription Keys",
       SUM(cnt_storage) AS "Number of Storage Subscription Keys",
       SUM(cnt_uxi) AS "Number of UXI Subscription Keys"
FROM
  (WITH nontest_user AS
     (select platform_customer_id,
             account_type,
             case
                 when is_test_workspace = true then 'Test Workspace'
                 when is_test_workspace = false then 'non Test Workspace'
                 when is_test_workspace is null then 'Test Workspace'
             end as test_type
      from "ccs-aquila-tahoe-customersdimension" c
      WHERE partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '1' DAY, 'yyyy-MM-dd') ),
        dsdefinedacct AS
     (SELECT customer_id AS platform_customer_id,
             CASE
                 WHEN c.organization_id IS NULL THEN 'v1'
                 ELSE 'v2'
             END AS workspace_auth_version
      FROM "ccs-aquila-louise-accountmanagement-customers" c
      WHERE c.platform_customer_id = 'PLATFORM_ACCOUNT' ),
        subs AS
     (SELECT platform_customer_id,
             evaluation_type,
             subscription_key,
             subscription_tier,
             subscription_start,
             subscription_end,
             CASE
                 WHEN subscription_type = 'CENTRAL_STORAGE' THEN 'Storage'
                 WHEN subscription_type = 'CENTRAL_COMPUTE' THEN 'Compute'
                 WHEN subscription_type LIKE 'UXI%' THEN 'UXI'
                 when subscription_type='OPSRAMP' THEN 'Opsramp'
                 ELSE 'Aruba'
             END AS BU_subtype
      FROM "ccs-aquila-tahoe-subscriptiondimension"
      WHERE partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '1' DAY, 'yyyy-MM-dd') ),
        all_subs as
     (SELECT s.platform_customer_id,
             workspace_auth_version,
             evaluation_type,
             subscription_key,
             subscription_tier,
             subscription_start,
             subscription_end,
             BU_subtype,
             test_type
      FROM subs s
      LEFT JOIN dsdefinedacct dda on s.platform_customer_id = dda.platform_customer_id
      LEFT JOIN nontest_user ntu on ntu.platform_customer_id = s.platform_customer_id) select test_type,
                                                                                              workspace_auth_version,
                                                                                              evaluation_type,
                                                                                              date_format(subscription_end, '%Y-%m') as sub_end_ym,
                                                                                              count(distinct case
                                                                                                                 when BU_subtype='Aruba' then subscription_key
                                                                                                                 else null
                                                                                                             end) as cnt_aruba,
                                                                                              count(distinct case
                                                                                                                 when BU_subtype='Compute' then subscription_key
                                                                                                                 else null
                                                                                                             end) as cnt_compute,
                                                                                              count(distinct case
                                                                                                                 when BU_subtype='Storage' then subscription_key
                                                                                                                 else null
                                                                                                             end) as cnt_storage,
                                                                                              count(distinct case
                                                                                                                 when BU_subtype='UXI' then subscription_key
                                                                                                                 else null
                                                                                                             end) as cnt_uxi
   from all_subs
   where date_format(subscription_end, '%Y-%m') between '2023-11' and '2025-12'
   group by 1,
            2,
            3,
            4) AS virtual_table
WHERE test_type IN ('non Test Workspace')
  AND ((evaluation_type IN ('EVAL')))
GROUP BY sub_end_ym
ORDER BY "Number of Aruba Subscription Keys" DESC
LIMIT 10000;

Number of Active Workspaces

SELECT bu_subtype AS bu_subtype,
       sum("MSP") AS "MSP__",
       sum("STANDALONE") AS "STANDALONE__",
       sum("TENANT") AS "TENANT__",
       sum("COI_TENANT") AS "TENANT_COI",
       sum("MOI_TENANT") AS "TENANT_MOI",
       SUM(MSP+TENANT+STANDALONE) AS "TOTAL"
FROM
  (WITH nontest_user AS
     (SELECT platform_customer_id,
             account_type,
             CASE
                 WHEN is_test_workspace = true THEN 'Test Workspace'
                 WHEN is_test_workspace = false THEN 'non Test Workspace'
                 WHEN is_test_workspace IS NULL THEN 'Test Workspace'
             END AS test_type
      FROM "ccs-aquila-tahoe-customersdimension"
      WHERE partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '1' DAY, 'yyyy-MM-dd') ),
        account_info AS
     (SELECT customer_id AS platform_customer_id,
             CASE
                 WHEN organization_id IS NULL THEN 'v1'
                 ELSE 'v2'
             END AS workspace_auth_version,
             account_type,
             operational_mode
      FROM "ccs-aquila-louise-accountmanagement-customers"
      WHERE platform_customer_id = 'PLATFORM_ACCOUNT' ),
        provisions AS
     (SELECT platform_customer_id,
             CASE
                 WHEN app_id = '683da368-66cb-4ee7-90a9-ec1964768092' THEN 'Aruba'
                 WHEN app_id = 'b394fa01-8858-4d73-8818-eadaf12eaf37' THEN 'Compute'
                 WHEN app_id = '980eea3c-b063-451e-8a45-ebcaa54fd561' THEN 'Storage'
                 WHEN app_id = '7cc837db-2045-4d58-a16f-b167bb9fd0d2' THEN 'UXI'
                 ELSE 'Others'
             END AS application_name
      FROM "ccs-aquila-louise-accountmanagement-customers"),
        active_subscriptions AS
     (SELECT platform_customer_id,
             CASE
                 WHEN subscription_type = 'CENTRAL_STORAGE' THEN 'Storage'
                 WHEN subscription_type = 'CENTRAL_COMPUTE' THEN 'Compute'
                 WHEN subscription_type LIKE 'UXI%' THEN 'UXI'
                 ELSE 'Aruba'
             END AS BU_subtype
      FROM "ccs-aquila-tahoe-subscriptiondimension"
      WHERE quantity < 10000000
        AND state_type = 'started'
        AND partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '1' DAY, 'yyyy-MM-dd') ),
        tenant_mapping AS
     (SELECT DISTINCT msp_id,
                      customer_id AS tenant_platform_customer_id,
                      operational_mode
      FROM "ccs-aquila-louise-accountmanagement-customers"
      WHERE msp_id IS NOT NULL ),
        active_workspaces AS
     (SELECT a.BU_subtype,
             u.test_type,
             acc.workspace_auth_version,
             COUNT(DISTINCT CASE
                                WHEN acc.account_type = 'MSP' THEN a.platform_customer_id
                            END) AS MSP,
             COUNT(DISTINCT CASE
                                WHEN acc.account_type = 'STANDALONE' THEN a.platform_customer_id
                            END) AS STANDALONE,
             COUNT(DISTINCT tm.tenant_platform_customer_id) AS TENANT,
             COUNT(DISTINCT CASE
                                WHEN tm.operational_mode = 'MSP_OWNED_INVENTORY' THEN tm.tenant_platform_customer_id
                            END) AS MOI_TENANT,
             COUNT(DISTINCT CASE
                                WHEN tm.operational_mode = 'CUSTOMER_OWNED_INVENTORY' THEN tm.tenant_platform_customer_id
                            END) AS COI_TENANT
      FROM active_subscriptions a
      INNER JOIN provisions p ON a.platform_customer_id = p.platform_customer_id
      AND a.BU_subtype = p.application_name
      LEFT JOIN account_info acc ON a.platform_customer_id = acc.platform_customer_id
      LEFT JOIN tenant_mapping tm ON acc.account_type = 'MSP'
      AND a.platform_customer_id = tm.msp_id
      LEFT JOIN nontest_user u ON a.platform_customer_id = u.platform_customer_id
      GROUP BY a.BU_subtype,
               u.test_type,
               acc.workspace_auth_version),
        total_aruba_uxi AS
     (SELECT 'Total: Aruba/UXI' AS BU_subtype,
             u.test_type,
             acc.workspace_auth_version,
             COUNT(DISTINCT CASE
                                WHEN acc.account_type = 'MSP' THEN a.platform_customer_id
                            END) AS MSP,
             COUNT(DISTINCT CASE
                                WHEN acc.account_type = 'STANDALONE' THEN a.platform_customer_id
                            END) AS STANDALONE,
             COUNT(DISTINCT tm.tenant_platform_customer_id) AS TENANT,
             COUNT(DISTINCT CASE
                                WHEN tm.operational_mode = 'MSP_OWNED_INVENTORY' THEN tm.tenant_platform_customer_id
                            END) AS MOI_TENANT,
             COUNT(DISTINCT CASE
                                WHEN tm.operational_mode = 'CUSTOMER_OWNED_INVENTORY' THEN tm.tenant_platform_customer_id
                            END) AS COI_TENANT
      FROM active_subscriptions a
      INNER JOIN provisions p ON a.platform_customer_id = p.platform_customer_id
      AND a.BU_subtype = p.application_name
      LEFT JOIN account_info acc ON a.platform_customer_id = acc.platform_customer_id
      LEFT JOIN tenant_mapping tm ON acc.account_type = 'MSP'
      AND a.platform_customer_id = tm.msp_id
      LEFT JOIN nontest_user u ON a.platform_customer_id = u.platform_customer_id
      WHERE a.BU_subtype IN ('Aruba',
                             'UXI')
      GROUP BY u.test_type,
               acc.workspace_auth_version),
        total_all AS
     (SELECT 'Total: Aruba/Compute/Storage/UXI' AS BU_subtype,
             u.test_type,
             acc.workspace_auth_version,
             COUNT(DISTINCT CASE
                                WHEN acc.account_type = 'MSP' THEN a.platform_customer_id
                            END) AS MSP,
             COUNT(DISTINCT CASE
                                WHEN acc.account_type = 'STANDALONE' THEN a.platform_customer_id
                            END) AS STANDALONE,
             COUNT(DISTINCT tm.tenant_platform_customer_id) AS TENANT,
             COUNT(DISTINCT CASE
                                WHEN tm.operational_mode = 'MSP_OWNED_INVENTORY' THEN tm.tenant_platform_customer_id
                            END) AS MOI_TENANT,
             COUNT(DISTINCT CASE
                                WHEN tm.operational_mode = 'CUSTOMER_OWNED_INVENTORY' THEN tm.tenant_platform_customer_id
                            END) AS COI_TENANT
      FROM active_subscriptions a
      INNER JOIN provisions p ON a.platform_customer_id = p.platform_customer_id
      AND a.BU_subtype = p.application_name
      LEFT JOIN account_info acc ON a.platform_customer_id = acc.platform_customer_id
      LEFT JOIN tenant_mapping tm ON acc.account_type = 'MSP'
      AND a.platform_customer_id = tm.msp_id
      LEFT JOIN nontest_user u ON a.platform_customer_id = u.platform_customer_id
      WHERE a.BU_subtype IN ('Aruba',
                             'Compute',
                             'Storage',
                             'UXI')
      GROUP BY u.test_type,
               acc.workspace_auth_version) SELECT *
   FROM active_workspaces
   UNION ALL SELECT *
   FROM total_aruba_uxi
   UNION ALL SELECT *
   FROM total_all) AS virtual_table
WHERE test_type IN ('non Test Workspace')
--AND workspace_auth_version IN ('v1') --forv1
--AND workspace_auth_version IN ('v2') --forv2
GROUP BY bu_subtype
ORDER BY "TOTAL" ASC
LIMIT 1000;

Number of end customers with more than 1 active workspace

SELECT segment AS segment,
                  sum(cnt_domain) AS "SUM(Number of User Domains)"
FROM
  (WITH nontest_user AS
     (SELECT customer_id,
             split(lower(username), '@')[2] AS user_email_domain
      FROM "ccs-aquila-louise-accountmanagement-customerusers"
      WHERE split(lower(username), '@')[2] NOT IN ('glcptest.com',
                                                   'esc-std.glcpsoltest.net',
                                                   'hpe.com',
                                                   'hpe.hr',
                                                   'hpecds.com',
                                                   'hpedemos.com',
                                                   'hpedemos.net',
                                                   'hpedev.io',
                                                   'hpelabsonline.com',
                                                   'hpevlabs.net',
                                                   'groups.ext.hpe.com',
                                                   'merlin.test.glc.hpe.com',
                                                   'recovery.auth.greenlake.hpe.com',
                                                   'testhpe.com',
                                                   'aruba-expert.com',
                                                   'aruba-workbench.com',
                                                   'aruba.flane.de',
                                                   'arubademo.net',
                                                   'arubanetworks.com',
                                                   'arubatraininglabs.net',
                                                   'arubaworkshops.net',
                                                   'gmail.com',
                                                   'yahoo.co.in',
                                                   'yahoo.co.uk',
                                                   'yahoo.com',
                                                   'yahoo.com.mx',
                                                   'outlook.com',
                                                   'outlook.com.br',
                                                   'outlook.dk',
                                                   'outlook.es',
                                                   'outlook.fr',
                                                   'hotmail.co.uk',
                                                   'hotmail.com',
                                                   'hotmail.de',
                                                   'hotmail.fr',
                                                   '126.com') ),
        nontest_customer AS
     (SELECT DISTINCT customer_id,
                      'non Test Workspace' AS if_test_workspace
      FROM nontest_user),
        dsdefinedacct AS
     (SELECT c.customer_id AS platform_customer_id,
             c.msp_id,
             c.account_type,
             c.account_status,
             COALESCE(nc.if_test_workspace, 'Test Workspace') AS if_test_workspace
      FROM "ccs-aquila-louise-accountmanagement-customers" c
      LEFT JOIN nontest_customer nc ON c.customer_id = nc.customer_id
      WHERE c.platform_customer_id = 'PLATFORM_ACCOUNT' ),
        provisions AS
     (SELECT platform_customer_id,
             CASE app_id
                 WHEN '683da368-66cb-4ee7-90a9-ec1964768092' THEN 'Aruba'
                 WHEN 'b394fa01-8858-4d73-8818-eadaf12eaf37' THEN 'Compute'
                 WHEN '980eea3c-b063-451e-8a45-ebcaa54fd561' THEN 'Storage'
                 WHEN 'f4cc7322-f1c0-4546-a06c-74e0c3894769' THEN 'Opsramp'
                 WHEN '7cc837db-2045-4d58-a16f-b167bb9fd0d2' THEN 'UXI'
                 ELSE 'Others'
             END AS application_name
      FROM "ccs-aquila-louise-accountmanagement-customers"
      WHERE platform_customer_id != 'PLATFORM_ACCOUNT' ),
        all_sub AS
     (SELECT subscription_key,
             evaluation_type,
             quantity,
             subscription_type,
             subscription_tier,
             subscription_start,
             subscription_end,
             platform_customer_id,
             state_type,
             CASE
                 WHEN subscription_type = 'CENTRAL_STORAGE' THEN 'Storage'
                 WHEN subscription_type = 'CENTRAL_COMPUTE' THEN 'Compute'
                 WHEN subscription_type = 'OPSRAMP' THEN 'Opsramp'
                 WHEN subscription_type LIKE 'UXI%' THEN 'UXI'
                 ELSE 'Aruba'
             END AS BU_subtype
      FROM "ccs-aquila-tahoe-subscriptiondimension"
      WHERE partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '1' DAY, 'yyyy-MM-dd') ),
        all_sub_acct AS
     (SELECT a.*,
             d.msp_id,
             d.account_type,
             d.account_status,
             d.if_test_workspace
      FROM all_sub a
      LEFT JOIN dsdefinedacct d ON a.platform_customer_id = d.platform_customer_id),
        active_sub AS
     (SELECT *
      FROM all_sub_acct
      WHERE state_type = 'started'
        AND BU_subtype IN ('Aruba',
                           'Compute',
                           'Storage',
                           'UXI')
        AND quantity < 10000000 ),
        active_acct_stdmsp AS
     (SELECT a.
      FROM active_sub a
      INNER JOIN provisions p ON a.platform_customer_id = p.platform_customer_id
      AND a.BU_subtype = p.application_name),
        non_test_domains AS
     (SELECT user_email_domain
      FROM nontest_user
      WHERE customer_id IN
          (SELECT platform_customer_id
           FROM active_acct_stdmsp
           WHERE if_test_workspace = 'non Test Workspace' )
        OR customer_id IN
          (SELECT d.platform_customer_id
           FROM dsdefinedacct d
           INNER JOIN active_acct_stdmsp aa ON d.msp_id = aa.platform_customer_id
           WHERE aa.if_test_workspace = 'non Test Workspace' )
      GROUP BY user_email_domain
      HAVING COUNT(DISTINCT customer_id) > 1),
        test_domains AS
     (SELECT user_email_domain
      FROM nontest_user
      WHERE customer_id IN
          (SELECT platform_customer_id
           FROM active_acct_stdmsp
           WHERE if_test_workspace = 'Test Workspace' )
        OR customer_id IN
          (SELECT d.platform_customer_id
           FROM dsdefinedacct d
           INNER JOIN active_acct_stdmsp aa ON d.msp_id = aa.platform_customer_id
           WHERE aa.if_test_workspace = 'Test Workspace' )
      GROUP BY user_email_domain
      HAVING COUNT(DISTINCT customer_id) > 1),
        non_test_std_domains AS
     (SELECT user_email_domain
      FROM nontest_user
      WHERE customer_id IN
          (SELECT platform_customer_id
           FROM active_acct_stdmsp
           WHERE if_test_workspace = 'non Test Workspace'
             AND account_type = 'STANDALONE' )
        OR customer_id IN
          (SELECT d.platform_customer_id
           FROM dsdefinedacct d
           INNER JOIN active_acct_stdmsp aa ON d.msp_id = aa.platform_customer_id
           WHERE aa.if_test_workspace = 'non Test Workspace'
             AND aa.account_type = 'STANDALONE' )
      GROUP BY user_email_domain
      HAVING COUNT(DISTINCT customer_id) > 1),
        test_std_domains AS
     (SELECT user_email_domain
      FROM nontest_user
      WHERE customer_id IN
          (SELECT platform_customer_id
           FROM active_acct_stdmsp
           WHERE if_test_workspace = 'Test Workspace'
             AND account_type = 'STANDALONE' )
        OR customer_id IN
          (SELECT d.platform_customer_id
           FROM dsdefinedacct d
           INNER JOIN active_acct_stdmsp aa ON d.msp_id = aa.platform_customer_id
           WHERE aa.if_test_workspace = 'Test Workspace'
             AND aa.account_type = 'STANDALONE' )
      GROUP BY user_email_domain
      HAVING COUNT(DISTINCT customer_id) > 1) SELECT 'non Test Workspace' AS test_type,
                                                     'more than 1 any active workspaces' AS segment,
                                                     COUNT() AS cnt_domain
   FROM non_test_domains
   UNION ALL SELECT 'Test Workspace',
                    'more than 1 any active workspaces',
                    COUNT()
   FROM test_domains
   UNION ALL SELECT 'non Test Workspace',
                    'more than 1 standalone workspaces',
                    COUNT()
   FROM non_test_std_domains
   UNION ALL SELECT 'Test Workspace',
                    'more than 1 standalone workspaces',
                    COUNT()
   FROM test_std_domains
   ORDER BY 1,
            2) AS virtual_table
WHERE test_type IN ('non Test Workspace')
GROUP BY segment
ORDER BY "SUM(Number of User Domains)" DESC
LIMIT 1000;

Number of Users (under active workspace)



SELECT type AS type,
               sum(cnt_users) AS "Number of Users"
FROM
  (WITH nontest_user AS
     (SELECT customer_id,
             lower(username) AS username,
             split(lower(username), '@')[2] AS user_email_domain
      FROM "ccs-aquila-louise-accountmanagement-customerusers"
      WHERE split(lower(username), '@')[2] NOT IN ('glcptest.com',
                                                   'esc-std.glcpsoltest.net',
                                                   'hpe.com',
                                                   'hpe.hr',
                                                   'hpecds.com',
                                                   'hpedemos.com',
                                                   'hpedemos.net',
                                                   'hpedev.io',
                                                   'hpelabsonline.com',
                                                   'hpevlabs.net',
                                                   'groups.ext.hpe.com',
                                                   'merlin.test.glc.hpe.com',
                                                   'recovery.auth.greenlake.hpe.com',
                                                   'testhpe.com',
                                                   'aruba-expert.com',
                                                   'aruba-workbench.com',
                                                   'aruba.flane.de',
                                                   'arubademo.net',
                                                   'arubanetworks.com',
                                                   'arubatraininglabs.net',
                                                   'arubaworkshops.net',
                                                   'gmail.com',
                                                   'yahoo.co.in',
                                                   'yahoo.co.uk',
                                                   'yahoo.com',
                                                   'yahoo.com.mx',
                                                   'outlook.com',
                                                   'outlook.com.br',
                                                   'outlook.dk',
                                                   'outlook.es',
                                                   'outlook.fr',
                                                   'hotmail.co.uk',
                                                   'hotmail.com',
                                                   'hotmail.de',
                                                   'hotmail.fr',
                                                   '126.com') ),
        nontest_customer AS
     (SELECT DISTINCT customer_id,
                      'non Test Workspace' AS if_test_workspace
      FROM nontest_user),
        dsdefinedacct AS
     (SELECT c.customer_id AS platform_customer_id,
             c.msp_id,
             c.account_type,
             c.account_status,
             COALESCE(nc.if_test_workspace, 'Test Workspace') AS if_test_workspace
      FROM "ccs-aquila-louise-accountmanagement-customers" c
      LEFT JOIN nontest_customer nc ON c.customer_id = nc.customer_id
      WHERE c.platform_customer_id = 'PLATFORM_ACCOUNT' ),
        provisions AS
     (SELECT platform_customer_id,
             CASE app_id
                 WHEN '683da368-66cb-4ee7-90a9-ec1964768092' THEN 'Aruba'
                 WHEN 'b394fa01-8858-4d73-8818-eadaf12eaf37' THEN 'Compute'
                 WHEN '980eea3c-b063-451e-8a45-ebcaa54fd561' THEN 'Storage'
                 WHEN 'f4cc7322-f1c0-4546-a06c-74e0c3894769' THEN 'Opsramp'
                 WHEN '7cc837db-2045-4d58-a16f-b167bb9fd0d2' THEN 'UXI'
                 ELSE 'Others'
             END AS application_name
      FROM "ccs-aquila-louise-accountmanagement-customers"
      WHERE platform_customer_id != 'PLATFORM_ACCOUNT' ),
        all_sub AS
     (SELECT subscription_key,
             evaluation_type,
             quantity,
             subscription_type,
             subscription_tier,
             subscription_start,
             subscription_end,
             platform_customer_id,
             state_type,
             CASE
                 WHEN subscription_type = 'CENTRAL_STORAGE' THEN 'Storage'
                 WHEN subscription_type = 'CENTRAL_COMPUTE' THEN 'Compute'
                 WHEN subscription_type = 'OPSRAMP' THEN 'Opsramp'
                 WHEN subscription_type LIKE 'UXI%' THEN 'UXI'
                 ELSE 'Aruba'
             END AS BU_subtype
      FROM "ccs-aquila-tahoe-subscriptiondimension"
      WHERE partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '1' DAY, 'yyyy-MM-dd') ),
        all_sub_acct AS
     (SELECT a.,
             d.msp_id,
             d.account_type,
             d.account_status,
             d.if_test_workspace
      FROM all_sub a
      LEFT JOIN dsdefinedacct d ON a.platform_customer_id = d.platform_customer_id),
        active_sub AS
     (SELECT *
      FROM all_sub_acct
      WHERE state_type = 'started'
        AND BU_subtype IN ('Aruba',
                           'Compute',
                           'Storage',
                           'UXI')
        AND quantity < 10000000 ),
        active_acct_stdmsp AS
     (SELECT a.
      FROM active_sub a
      INNER JOIN provisions p ON a.platform_customer_id = p.platform_customer_id
      AND a.BU_subtype = p.application_name),
        non_test_customer_ids AS
     (SELECT customer_id
      FROM
        (SELECT platform_customer_id AS customer_id
         FROM active_acct_stdmsp
         WHERE if_test_workspace = 'non Test Workspace'
         UNION SELECT d.platform_customer_id AS customer_id
         FROM dsdefinedacct d
         INNER JOIN active_acct_stdmsp a ON d.msp_id = a.platform_customer_id
         WHERE a.if_test_workspace = 'non Test Workspace' )),
        final_users AS
     (SELECT nu.username,
             u.type
      FROM nontest_user nu
      JOIN non_test_customer_ids c ON nu.customer_id = c.customer_id
      JOIN "ccs-aquila-louise-accountmanagement-users" u ON nu.username = u.username) SELECT 'non Test Workspace' AS test_type,
                                                                                             type,
                                                                                             COUNT(DISTINCT username) AS cnt_users
   FROM final_users
   GROUP BY type
   ORDER BY test_type,
            type) AS virtual_table
WHERE test_type IN ('non Test Workspace')
GROUP BY type
ORDER BY "Number of Users" DESC
LIMIT 1000;

Number of MFA Workspaces/Users (exclude hpe.com)

SELECT cnt_pcid AS "Number of Workspaces"
FROM
  (select count(distinct customer_users.platform_customer_id) as cnt_pcid
   FROM
     (SELECT *
      FROM "ccs-aquila-tahoe-usersdimension"
      WHERE partition_date = FORMAT_DATETIME(CURRENT_DATE - INTERVAL '2' DAY, 'yyyy-MM-dd') ) as customer_users
   JOIN "ccs-aquila-louise-accountmanagement-customerpreferences" as customer_preferences ON customer_users.platform_customer_id = customer_preferences.customer_id
   where customer_preferences.multi_fa_enabled = true
     and customer_users.username not like '%@hpe.com') AS virtual_table
ORDER BY "Number of Workspaces" DESC
LIMIT 1000;

